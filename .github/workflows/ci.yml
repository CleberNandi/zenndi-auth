# FINAL PV WORKFLOW - CI/CD COMPLETO
name: CI/CD - Build, Test, and Deploy

on:
  push:
    branches:
      - "feature/**"
      - "dev"
      - "hml"
      - "main"
  pull_request:
    branches:
      - "dev"
      - "hml"
      - "main"

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  packages: write
  id-token: write

jobs:
  check-branch-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Block direct pushes to protected branches
        run: |
          PROTECTED_BRANCHES=("refs/heads/dev" "refs/heads/hml" "refs/heads/main")
          if [[ " ${PROTECTED_BRANCHES[@]} " =~ " ${GITHUB_REF} " ]]; then
            echo "‚ùå Direct pushes to '${GITHUB_REF#refs/heads/}' are not allowed."
            echo "Please use a feature branch and open a Pull Request."
            exit 1
          fi
          echo "‚úÖ Push is to a feature branch. Proceeding..."

  test:
    runs-on: ubuntu-latest
    needs: check-branch-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file for CI
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        run: |
          echo "Creating .env file for testing..."
          cat <<EOF > .env
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DB=${POSTGRES_DB}
          DATABASE_URL="postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}"
          REDIS_URL="redis://redis:6379/0"
          ENV_MODE=test
          SECRET_KEY=a-very-secret-key-for-ci-that-is-not-production
          ALGORITHM=HS256
          SMTP_USER=test@example.com
          SMTP_PASSWORD=password
          SMTP_SERVER=mail.example.com
          SMTP_PORT=587
          EOF

      - name: Start services (DB + Redis)
        run: docker compose -f docker-compose.ci.yml up -d db redis

      - name: Wait for services
        run: |
          echo "Waiting for DB and Redis to be healthy..."
          for i in $(seq 1 12); do
            DB_STATUS=$(docker inspect -f '{{.State.Health.Status}}' $(docker compose -f docker-compose.ci.yml ps -q db))
            REDIS_STATUS=$(docker inspect -f '{{.State.Health.Status}}' $(docker compose -f docker-compose.ci.yml ps -q redis))
            if [ "$DB_STATUS" = "healthy" ] && [ "$REDIS_STATUS" = "healthy" ]; then
              echo "‚úÖ All services are healthy!"
              break
            fi
            echo "Services not ready yet... waiting 5s (DB: $DB_STATUS, Redis: $REDIS_STATUS)"
            sleep 5
          done
          if [ "$DB_STATUS" != "healthy" ] || [ "$REDIS_STATUS" != "healthy" ]; then
            echo "‚ùå Services did not become healthy"
            docker compose -f docker-compose.ci.yml logs
            exit 1
          fi

      - name: Build API image for testing
        run: docker compose -f docker-compose.ci.yml build api

      - name: Run Alembic migrations
        run: docker compose -f docker-compose.ci.yml run --rm api uv run alembic upgrade head

      - name: Run tests
        run: |
          docker compose -f docker-compose.ci.yml run --rm api uv run pytest || \
            (test $? -eq 5 && echo "‚úÖ Pytest passou sem encontrar testes." || exit $? )

      - name: Tear down services
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v --remove-orphans

  create-pr:
    runs-on: ubuntu-latest
    needs: test
    if: success() && startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract feature branch info
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          FEATURE_NAME=${BRANCH_NAME#feature/}
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "FEATURE_NAME=$FEATURE_NAME" >> $GITHUB_ENV

      - name: Check if PR exists
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${process.env.BRANCH_NAME}`,
              base: 'dev',
              state: 'open'
            });
            if (pulls.length > 0) core.setOutput('exists', 'true');
            else core.setOutput('exists', 'false');

      - name: Create PR
        if: steps.check.outputs.exists == 'false'
        uses: repo-sync/pull-request@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        with:
          source_branch: ${{ env.BRANCH_NAME }}
          destination_branch: dev
          pr_title: "‚ú® Feature: ${{ env.FEATURE_NAME }}"
          pr_body: |
            ## üöÄ Auto PR - Feature Branch
            Branch: `${{ env.BRANCH_NAME }}`
            Testes: ‚úÖ Passaram com sucesso
          github_token: ${{ secrets.GITHUB_TOKEN }}

  build-and-push:
    runs-on: ubuntu-latest
    needs: test
    if: success() && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/hml' || github.ref == 'refs/heads/dev')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract branch name
        run: echo "BRANCH_NAME=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

      - name: Generate tags
        id: meta
        run: |
          REPO="ghcr.io/${{ github.repository_owner }}/zenndi-auth"
          BRANCH="${{ env.BRANCH_NAME }}"
          if [ "$BRANCH" = "main" ]; then
            echo "tags=$REPO:latest,$REPO:${{ github.run_number }}" >> $GITHUB_OUTPUT
          else
            echo "tags=$REPO:$BRANCH" >> $GITHUB_OUTPUT
          fi

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./build/deployments/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max